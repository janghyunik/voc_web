{% extends "base.html" %}
{% block content %}

<!-- MTBI ì¹´ë“œ -->
<section class="card">
  <div class="section-title">
    <h2>ì„¤ë¹„ MTBI ì§€ìˆ˜</h2>
    <div class="mtbi-tabs">
      <button class="mtbi-tab active" data-range="daily">ì¼ê°„</button>
      <button class="mtbi-tab" data-range="weekly">ì£¼ê°„</button>
      <button class="mtbi-tab" data-range="monthly">ì›”ê°„</button>
    </div>
  </div>

  <div class="mtbi-chart-wrap" style="height:300px;">
    <canvas id="mtbiChart"></canvas>
  </div>

  {% if (not mtbi.daily) and (not mtbi.weekly) and (not mtbi.monthly) %}
    <div class="empty">
      <p>MTBI ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      <p class="muted">data/mtbi.json íŒŒì¼ì— ì§‘ê³„ ê²°ê³¼ë¥¼ ë„£ì–´ì£¼ì‹œë©´ ìë™ìœ¼ë¡œ ê·¸ë˜í”„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
  {% endif %}
</section>

<section class="grid-2">
  <!-- ìµœì‹  ì „ë‹¬ì‚¬í•­ -->
  <div class="card">
    <div class="section-title">
      <h2>ë¶€ì„œ ì „ë‹¬ì‚¬í•­</h2>
      <a class="btn-secondary" href="{{ url_for('announcements_list') }}">ë” ë³´ê¸°</a>
    </div>
    <ul class="list">
      {% if top_ann %}
        {% for ann in top_ann %}
          <li>
            <a class="ann-item" href="{{ url_for('announcements_detail', ann_id=ann.id) }}">
              <span class="ann-title">{{ ann.title }}</span>
              <span class="ann-date">{{ ann.created_at.strftime('%Y-%m-%d') }}</span>
            </a>
          </li>
        {% endfor %}
      {% else %}
        <li class="muted">ë“±ë¡ëœ ì „ë‹¬ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ 'ì „ë‹¬ì‚¬í•­ ë“±ë¡'ì—ì„œ ì‘ì„±í•˜ì„¸ìš”.</li>
      {% endif %}
    </ul>
  </div>

  <!-- ìƒì¼Â·ê¸°ë…ì¼ ìœ„ì ¯ -->
  <div class="card">
    <div class="section-title">
      <h2>ì´ë²ˆ ì£¼ ìƒì¼Â·ê¸°ë…ì¼</h2>
      <span class="muted">data/birthdays.json ê¸°ì¤€</span>
    </div>

    {% if bday_events and bday_events|length > 0 %}
      <ul class="bday-list">
        {% for ev in bday_events %}
          <li class="bday-item">
            <div class="bday-left">
              <span class="bday-type {% if ev.type == 'ìƒì¼' %}cake{% else %}anniv{% endif %}">
                {% if ev.type == 'ìƒì¼' %}ğŸ‚{% else %}ğŸˆ{% endif %}
                {{ ev.type }}
              </span>
              <span class="bday-name">{{ ev.name }}</span>
              <span class="bday-date">{{ ev.display }}</span>
            </div>
            <div class="bday-right">
              <span class="bday-when {% if ev.is_today %}today{% endif %}">
                {{ ev.when }}
              </span>
              <button class="msg-btn" data-name="{{ ev.name }}" data-type="{{ ev.type }}">ë©”ì‹œì§€</button>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty">
        <p>ì´ë²ˆ ì£¼ ìƒì¼Â·ê¸°ë…ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <p class="muted">data/birthdays.json íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
    {% endif %}
  </div>
</section>

<!-- í–‰ì‚¬ ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ -->
<section class="card">
  <div class="section-title">
    <h2>í–‰ì‚¬ ì‚¬ì§„</h2>
    <span class="muted">static/gallery/events í´ë” ì‚¬ì§„ ìë™ í‘œì‹œ</span>
  </div>

  {% if images %}
    <div class="carousel">
      <button class="car-arrow left" id="carPrev">â€¹</button>
      <div class="car-track" id="galleryTrack">
        {% for it in images %}
          <div class="car-item">
            <a href="{{ url_for('static', filename=it.src) }}" target="_blank" class="gallery-imgwrap">
              <img src="{{ url_for('static', filename=it.src) }}" alt="event">
            </a>
            <div class="like-bar">
              <button class="like-btn" data-img="{{ it.name }}">ğŸ‘ ì¢‹ì•„ìš”</button>
              <span class="like-count" id="like_{{ it.name|replace('.','_') }}">{{ likes.get(it.name, 0) }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
      <button class="car-arrow right" id="carNext">â€º</button>
    </div>
  {% else %}
    <div class="empty">
      <p>í‘œì‹œí•  ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      <p class="muted">static/gallery/events í´ë”ì— ì´ë¯¸ì§€ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.</p>
    </div>
  {% endif %}
</section>

<div id="toast" class="toast" style="display:none;">ë©”ì‹œì§€ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤ ğŸ‰</div>

<!-- Chart.js & DataLabels plugin (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  // ================= MTBI í˜¼í•© ì°¨íŠ¸ (ë§‰ëŒ€ + ì„  + ê°’ ë¼ë²¨) =================
  const mtbiData = {{ mtbi | tojson | safe }};

  (function initMtbiChart() {
    const ctx = document.getElementById('mtbiChart');
    if (!ctx) return;

    // í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    if (window.ChartDataLabels) {
      Chart.register(ChartDataLabels);
    }

    function toDataset(range) {
      if (range === 'daily') {
        const ds = mtbiData.daily || [];
        return {
          labels: ds.map(x => x.date),
          values: ds.map(x => x.mtbi)
        };
      }
      if (range === 'weekly') {
        const ds = mtbiData.weekly || [];
        return {
          labels: ds.map(x => x.label),
          values: ds.map(x => x.mtbi)
        };
      }
      if (range === 'monthly') {
        const ds = mtbiData.monthly || [];
        return {
          labels: ds.map(x => x.label),
          values: ds.map(x => x.mtbi)
        };
      }
      return { labels: [], values: [] };
    }

    let currentRange = 'daily';
    let ds = toDataset(currentRange);

    if ((!ds.labels || ds.labels.length === 0) &&
        (!mtbiData.weekly || !mtbiData.weekly.length) &&
        (!mtbiData.monthly || !mtbiData.monthly.length)) {
      return;
    }

    // ê³µí†µ í¬ë§¤í„° (ì†Œìˆ˜ 1ìë¦¬)
    const fmt = (v) => {
      if (v === null || v === undefined) return '';
      const num = Number(v);
      if (Number.isNaN(num)) return '';
      return num.toFixed(1);
    };

    const chart = new Chart(ctx, {
      data: {
        labels: ds.labels,
        datasets: [
          {
            type: 'bar',
            label: 'MTBI',
            data: ds.values,
            backgroundColor: 'rgba(59, 130, 246, 0.28)',
            borderColor: 'rgba(59, 130, 246, 0.9)',
            borderWidth: 1,
            borderRadius: 6,
            yAxisID: 'y',
            // ë§‰ëŒ€ ìœ„ ê°’ ë¼ë²¨
            datalabels: {
              anchor: 'end',
              align: 'end',
              offset: 2,
              color: '#1f2937',
              font: { weight: '700', size: 10 },
              formatter: fmt,
              clamp: true
            }
          },
          {
            type: 'line',
            label: 'ì¶”ì„¸',
            data: ds.values,
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 2,
            tension: 0.25,
            fill: false,
            pointRadius: 2,
            pointBackgroundColor: 'rgba(37, 99, 235, 1)',
            yAxisID: 'y',
            // ì„  ìœ„ ê°’ ë¼ë²¨ (ë§‰ëŒ€ ë¼ë²¨ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì•½ê°„ ìœ„/ì˜¤í”„ì…‹)
            datalabels: { display: false }
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            display: true,
            labels: { boxWidth: 14, font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => ` ${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`
            }
          },
          // ì „ì—­ datalabels ì˜µì…˜(í•„ìš” ì‹œ)
          datalabels: {
            // ê²¹ì¹¨ì´ ì‹¬í•˜ë©´ ë‹¤ìŒ ì˜µì…˜ì„ ì¼¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // clip: true, // ì°¨íŠ¸ ì˜ì—­ ë°–ì€ ì˜ë¼ë‚´ê¸°
          }
        },
        scales: {
          x: {
            ticks: { maxRotation: 0, autoSkip: true },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'MTBI' },
            ticks: { stepSize: 1 },
            grid: { color: 'rgba(148, 163, 253, 0.15)' }
          }
        }
      }
    });

    // íƒ­ ì „í™˜: ì¼ê°„ / ì£¼ê°„ / ì›”ê°„
    document.querySelectorAll('.mtbi-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const range = btn.getAttribute('data-range');
        if (range === currentRange) return;

        currentRange = range;
        document.querySelectorAll('.mtbi-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const next = toDataset(range);
        chart.data.labels = next.labels;
        chart.data.datasets[0].data = next.values; // ë§‰ëŒ€
        chart.data.datasets[1].data = next.values; // ì„ (ì¶”ì„¸)
        chart.update();
      });
    });
  })();

  // ================= í–‰ì‚¬ ì‚¬ì§„ ìºëŸ¬ì…€ =================
  (function () {
    const track = document.getElementById('galleryTrack');
    const prev = document.getElementById('carPrev');
    const next = document.getElementById('carNext');
    if (!track) return;
    const scrollByPage = () => track.clientWidth * 0.9;
    prev && prev.addEventListener('click', () => {
      track.scrollBy({ left: -scrollByPage(), behavior: 'smooth' });
    });
    next && next.addEventListener('click', () => {
      track.scrollBy({ left: scrollByPage(), behavior: 'smooth' });
    });
  })();

  // ================= í–‰ì‚¬ ì‚¬ì§„ ì¢‹ì•„ìš” =================
  (function () {
    function like(imgName) {
      fetch('{{ url_for("api_gallery_like") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ img: imgName })
      })
      .then(r => r.json())
      .then(d => {
        if (!d.ok) return;
        const el = document.getElementById('like_' + imgName.replaceAll('.', '_'));
        if (el) el.textContent = d.likes;
        localStorage.setItem('liked_' + imgName, '1');
      })
      .catch(() => {});
    }

    document.querySelectorAll('.like-btn').forEach(btn => {
      const img = btn.getAttribute('data-img');
      if (localStorage.getItem('liked_' + img) === '1') {
        btn.classList.add('liked');
      }
      btn.addEventListener('click', () => {
        if (localStorage.getItem('liked_' + img) === '1') return;
        like(img);
        btn.classList.add('liked');
      });
    });
  })();

  // ================= ìƒì¼/ê¸°ë…ì¼ ì¶•í•˜ ë©”ì‹œì§€ ë³µì‚¬ =================
  (function () {
    const toast = document.getElementById('toast');

    function showToast() {
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 1500);
    }

    function makeMessage(name, type) {
      if (type === 'ê¸°ë…ì¼') {
        return `${name}ë‹˜, ê¸°ë…ì¼ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤! í•­ìƒ í–‰ë³µí•˜ì„¸ìš” ğŸˆ`;
      }
      return `${name}ë‹˜, ìƒì¼ ì¶•í•˜í•©ë‹ˆë‹¤! í–‰ë³µí•˜ê³  ê±´ê°•í•œ í•œ í•´ ë˜ì„¸ìš” ğŸ‚ğŸ‰`;
    }

    document.querySelectorAll('.msg-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const name = btn.getAttribute('data-name');
        const type = btn.getAttribute('data-type');
        const msg = makeMessage(name, type);
        try {
          await navigator.clipboard.writeText(msg);
        } catch (e) {
          const tmp = document.createElement('textarea');
          tmp.value = msg;
          document.body.appendChild(tmp);
          tmp.select();
          document.execCommand('copy');
          tmp.remove();
        }
        showToast();
      });
    });
  })();
</script>

{% endblock %}
